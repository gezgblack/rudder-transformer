bindings:
  - path: ./config
steps:
  - name: prepareContext
    template: $setContext("batchMode", true)
  - name: transform
    externalWorkflow:
      path: ./pinterest_tag_single_workflow.yaml
    loopOverInput: true
  - name: processTransformOutput
    description: Separate Failed and successful events
    template: |
      (
        $zipInputAndOutput := $map($zip($, $outputs.transform), $merge);
        {
          "successfulEvents": $zipInputAndOutput[$exists(output)],
          "failedEvents": $zipInputAndOutput[$exists(error)]
        }
      )
  - name: successfulEvents
    description: Batches the successfulEvents
    template: |
      (
        /* Prepares batch requests*/
        $prepareBatchRequest := function($batch) {(
          {
            "body": {
              "JSON": {"data": $batch.output},
              "JSON_ARRAY": {},
              "XML": {},
              "FORM": {}
            },
            "version": "1",
            "type": "REST",
            "method": "POST",
            "endpoint": $ENDPOINT,
            "headers": {
              "Content-Type": "application/json"
            },
            "params": {},
            "files": {}
          }
        )};
        $batches := $chunk($outputs.processTransformOutput.successfulEvents, $MAX_BATCH_SIZE);
        $map($batches, function($batch){(
          {
            "batchedRequest": $prepareBatchRequest($batch),
            "metadata": $batch.metadata,
            "batched": true,
            "statusCode": 200,
            "destination": $batch[0].destination
          }
        )})[];
      )
  - name: failedEvents
    template: |
      $outputs.processTransformOutput.failedEvents.{
        "metadata": [metadata],
        "batched": false,
        "statusCode": error.status,
        "error": error.message
      }
  - name: finalPayload
    template: |
      $outputs.($append(successfulEvents, failedEvents))
