bindings:
- path: ./util
- name: API_VERSION
  path: ./config
- name: EventType
  path: ../../../constants
steps:
- name: checkIfAlreadyProcessed
  condition: message.statusCode = 200
  template: |
    message
  onComplete: return
- name: validation
  template: |
    (
      $assert($exists(message.type), "Message type is not present. Aborting message.");
      $assert(message.type in [$EventType.IDENTIFY, $EventType.TRACK], "Message type " & message.type & " is not supported");
      $validateDestinationConfig(destination);
    )
- name: isLegacyAPI
  template: $not($exists(destination.Config.apiVersion)) or destination.Config.apiVersion = $API_VERSION.v1
- name: prepareContext
  template: |
      $setContext("transformedMessage", message)
- name: IsRETL
  description: Checks if event is generated by rETL
  template: message.context.mappedToDestination or false
- name: splitEventsForCreateUpdate
  description: |
    users from rETL might already exist in hubspot so we need 
    separate create and update events
  condition: $outputs.IsRETL
  template: |
    (
      $newMessage := $splitEventsForCreateUpdate([$], destination)[0].message;
      $setContext("transformedMessage", $newMessage)
    )
- name: processIdentify
  bindings:
  - path: ./HSTransform-v1
    name: processLegacyIdentify
  - path: ./HSTransform-v2
    name: processIdentify
  condition: message.type = $EventType.IDENTIFY
  steps:
  - name: processIdentifyForV3
    condition: $not($outputs.isLegacyAPI)
    template: |
      (
        [$processIdentify($context.transformedMessage, destination, $context.propertyMap)]
      )
  - name: processIdentifyForLegacy
    condition: $outputs.isLegacyAPI
    template: |
      (
        [$processLegacyIdentify($context.transformedMessage, destination, $context.propertyMap)]
      )
- name: processTrack
  bindings:
  - path: ./HSTransform-v1
    name: processLegacyTrack
  - path: ./HSTransform-v2
    name: processTrack
  condition: message.type = $EventType.TRACK
  steps:
  - name: processTrackForV3
    condition: $not($outputs.isLegacyAPI)
    template: |
      (
        $processTrack($context.transformedMessage, destination, $context.propertyMap)
      )
  - name: processTrackForLegacy
    condition: $outputs.isLegacyAPI
    template: |
      (
        $processLegacyTrack($context.transformedMessage, destination, $context.propertyMap)
      )